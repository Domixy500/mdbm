var mdbm=function(e){"use strict";function n(){libByName("Object"),libByName("mdbm.Type")}function t(e){return libByName("mdbm.Type").entries().find(n=>n.field("Name")===e)}function s(e){return void 0!==t(e)}function i(e){return!s(e)}const o={alreadyExists:function(e){return"Type '"+e+"' does already exist!"},isMissing:function(e){return"Type '"+e+"' does not exist!"}};function c(e,n){e.field("hasTypes").map(e=>e.field("Name")).includes(n)||e.link("hasTypes",t(n))}const r={open:function(e){e.set("hasTypes",t("Object"))},post:function(e){return c(e,"Object"),c(e,e.field("Name")),e}};const f={check:function(e){if(i(e))throw o.isMissing(e)},create:function(e,n){if(s(e))throw o.existsAlready(e);return function(e,n){const t=libByName("mdbm.Type").create({});t.set("Name",e),void 0===n?r.open(t):t.set("hasTypes",n.field("hasTypes"));return r.post(t),t}(e,n)},emptyIds:function(e){const n=t(e).field("hasTypes").map(e=>e.field("Name")),s=Object.create(null);return n.forEach(e=>s[e]=null),s},isMissing:i,messages:o,onCreate:r},u={post:function(e){n(),f.isMissing(e.title)&&message("Type '"+e.title+"' is not defined!")}};const a={onOpen:u},l={parse:function(e){return JSON.parse(e)},stringify:function(e){return JSON.stringify(e,null,2)}};function d(e){return e.field("mdbm.Type")}const m={addMissing:function(e){const n=Object.assign(Object.create(null),f.emptyIds(d(e)),p(e));y(e,n)},createMissing:function(e){const n=p(e);Object.keys(n).forEach(function(e){if(null===n[e]){const t=libByName(e).create({});n[e]=t.id}}),y(e,n)},get:function(e,n){return p(e)[n]},getAll:p,set:b,setAll:y,setEmpty:function(e){const n=f.emptyIds(d(e));y(e,n)},setSelf:function(e){b(e,d(e),e.id)}};function p(e){return l.parse(e.field("mdbm.Ids"))}function y(e,n){e.set("mdbm.Ids",l.stringify(n))}function b(e,n,t){const s=p(e);s[n]=t,y(e,s)}const g={open:function(e,n){},post:function(e){m.addMissing(e),m.createMissing(e)}};const h={open:function(e,n){const t=n.title;if(f.isMissing(t))throw n.show(),f.messages.isMissing(t);e.set("mdbm.Type",t),m.setEmpty(e)},post:function(e){m.setSelf(e),g.post(e)}};const N={create:function(e){const n=libByName(e).create({});h.open(n,libByName(e)),h.post(n),n.show()},onCreate:h};return e.library=a,e.object=N,e.type=f,e}({});

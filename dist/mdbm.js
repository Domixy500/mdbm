var mdbm=function(n){"use strict";function t(n){return libByName(n)}function e(){t("Object"),t("mdbm.Type")}function s(n){return libByName("mdbm.Type").entries().find(t=>t.field("Name")===n)}function i(n){return void 0!==s(n)}function o(n){return!i(n)}const c={post:function(n){e(),o(n.title)&&message("Type '"+n.title+"' is not defined!")}};const r={createEntry:function(n){return t(n).create({})},get:t,onOpen:c},u={parse:function(n){return JSON.parse(n)},stringify:function(n){return JSON.stringify(n,null,2)}};const f={json:u},a={alreadyExists:function(n){return"Type '"+n+"' does already exist!"},isMissing:function(n){return"Type '"+n+"' does not exist!"}};const l="hasTypes";function d(n,t){const e=function(n){return n.field(l)}(n).map(n=>n.field("Name"));e.includes(t)||n.link(l,s(t))}const p={open:function(n){n.set("hasTypes",s("Object"))},post:function(n){return d(n,"Object"),d(n,n.field("Name")),n}};function m(n,t){return n[t]=null,n}const y={check:function(n){if(o(n))throw a.isMissing(n)},create:function(n,t){if(i(n))throw a.existsAlready(n);return function(n,t){const e=r.createEntry("mdbm.Type");e.set("Name",n),void 0===t?p.open(e):e.set("hasTypes",t.field("hasTypes"));return p.post(e),e}(n,t)},emptyIds:function(n){return function(n){return s(n).field("hasTypes").map(n=>n.field("Name"))}(n).reduce(m,Object.create(null))},isMissing:o,messages:a,onCreate:p};function g(n){return n.field("mdbm.Type")}const b={addMissing:function(n){const t=Object.assign(Object.create(null),y.emptyIds(g(n)),T(n));N(n,t)},createMissing:function(n){const t=T(n);Object.keys(t).forEach(function(n){null===t[n]&&(t[n]=r.createEntry(n).id)}),N(n,t)},get:function(n,t){return T(n)[t]},getAll:T,set:j,setAll:N,setEmpty:function(n){const t=y.emptyIds(g(n));N(n,t)},setSelf:function(n){j(n,g(n),n.id)}},h="mdbm.Ids";function T(n){return f.json.parse(n.field(h))}function j(n,t,e){const s=T(n);s[t]=e,N(n,s)}function N(n,t){n.set(h,f.json.stringify(t))}function O(n){const t=y.fromObjectEntry(n).field("DisplayNamePattern").replace(/\$\{(.*?)\}/g,(t,e)=>function(n,t){return n.field(t)}(n,e));return n.set("DisplayName",t),t}const E={open:function(n,t){message("nothing")},post:function(n){b.addMissing(n),b.createMissing(n),message(O(n))}};const M={open:function(n,t){const e=t.title;if(y.isMissing(e))throw t.show(),y.messages.isMissing(e);n.set("mdbm.Type",e),b.setEmpty(n)},post:function(n){b.setSelf(n),E.post(n)}};const w={create:function(n){const t=r.createEntry(n);M.open(t,r.get(n)),M.post(t),t.show()},displayName:O,onCreate:M};return n.library=r,n.object=w,n.type=y,n}({});
